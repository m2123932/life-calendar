<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ°¸æ†äººç”Ÿé€±æ›† - å®šä½è·³è½‰ç‰ˆ</title>
    <style>
        :root {
            --wood-dark: #3e2723;
            --wood-med: #5d4037;
            --paper: #fdfaf1;
            --accent: #8d6e63;
            /* ç²‰å½©ç­† 8 è‰² */
            --p1: #FFB7B2; --p2: #FFDAC1; --p3: #E2F0CB; --p4: #B5EAD7;
            --p5: #C7CEEA; --p6: #F3FFE3; --p7: #FFCCF9; --p8: #B2E2F2;
        }

        body {
            background-color: var(--wood-dark);
            background-image: url('https://www.transparenttextures.com/patterns/dark-wood.png');
            color: var(--wood-dark);
            font-family: "PingFang TC", "Microsoft JhengHei", serif;
            margin: 0; padding: 20px;
            display: flex; flex-direction: column; align-items: center;
        }

        .header-card {
            background: var(--paper);
            padding: 25px; border-radius: 12px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.5);
            text-align: center; margin-bottom: 25px;
            width: 90%; max-width: 850px; border: 3px solid var(--wood-med);
        }

        .control-row {
            display: flex; flex-wrap: wrap; justify-content: center; gap: 15px;
            margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px dashed #ccc;
        }

        .stats { display: flex; justify-content: space-around; font-weight: bold; }

        .calendar-outer {
            background: var(--paper); padding: 15px; border-radius: 8px;
            overflow-x: auto; max-width: 95vw; box-shadow: inset 0 0 10px rgba(0,0,0,0.2);
            scroll-behavior: smooth;
        }

        .grid {
            display: grid; grid-template-columns: repeat(52, 18px); gap: 3px;
            user-select: none;
        }

        .cell {
            width: 18px; height: 18px; border: 1px solid rgba(0,0,0,0.1);
            font-size: 11px; text-align: center; line-height: 18px;
            cursor: pointer; transition: 0.2s; background: #ffffffcc;
            box-sizing: border-box;
        }

        /* ç‹€æ…‹ */
        .cell.selected { outline: 2px solid #ff5722; z-index: 10; transform: scale(1.1); }
        .cell.past { filter: brightness(0.95); border-style: dotted; }
        .cell.present { border: 2px solid #d32f2f; animation: pulse 2s infinite; }
        
        /* å®šä½é–ƒçˆæ•ˆæœ */
        .cell.target-highlight {
            outline: 3px solid #000;
            animation: highlight-blink 1s 3; 
            z-index: 20;
        }

        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        @keyframes highlight-blink { 0%, 100% { transform: scale(1); background-color: yellow; } 50% { transform: scale(1.5); background-color: white; } }

        /* ç·¨è¼¯é¸å–® */
        #editor-modal {
            display: none; position: fixed; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            background: var(--paper); padding: 25px; border-radius: 15px;
            box-shadow: 0 0 50px rgba(0,0,0,0.8); z-index: 100;
            border: 5px solid var(--wood-med); text-align: center; min-width: 280px;
        }

        .color-palette { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin: 15px 0; }
        .color-opt { 
            width: 35px; height: 35px; border-radius: 6px; cursor: pointer; 
            border: 1px solid #ccc; transition: 0.2s;
        }
        .color-opt:hover { transform: scale(1.1); }
        .color-opt.active { border: 3px solid #333; }
        
        .btn-group { display: flex; flex-direction: column; gap: 8px; margin-top: 15px; }
        button { 
            background: var(--wood-med); color: white; border: none; 
            padding: 8px 15px; border-radius: 5px; cursor: pointer; font-weight: bold;
        }
        button:hover { opacity: 0.9; }
        button.jump-btn { background: #5d4037; }
        button.clear-btn { background: #d7ccc8; color: #3e2723; border: 1px solid #a1887f; }
        button.cancel-btn { background: #999; }

        .overlay {
            display: none; position: fixed; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.6); z-index: 90;
        }

        input { padding: 5px; border-radius: 4px; border: 1px solid #ccc; }
    </style>
</head>
<body>

<div class="header-card">
    <h2>âŒ› æ°¸æ†äººç”Ÿé€±æ›†</h2>
    
    <div class="control-row">
        <div>
            ğŸ‘¶ å‡ºç”Ÿæ—¥æœŸï¼š<input type="date" id="birthday-input">
            <button onclick="updateBirthday()">æ›´æ–°é€±æ›†</button>
        </div>
        <div style="background: #efebe9; padding: 5px 15px; border-radius: 8px;">
            ğŸ” è·³è½‰æ—¥æœŸï¼š<input type="date" id="jump-date-input">
            <button class="jump-btn" onclick="jumpToDate()">å®šä½æ ¼å­</button>
        </div>
    </div>

    <div class="stats">
        <span>ç›®å‰ç¬¬ <span id="cur-week" style="color:#d32f2f">-</span> é€±</span>
        <span>å‰©é¤˜ <span id="rem-week" style="color:#2e7d32">-</span> é€±</span>
    </div>
</div>

<div class="calendar-outer" id="calendar-scroll-area">
    <div style="display: flex; justify-content: space-between; font-size: 10px; margin-bottom: 5px; color: var(--wood-med); width: 1100px;">
        <span>ç¬¬ 1 é€±</span><span>ç¬¬ 13 é€±</span><span>ç¬¬ 26 é€±</span><span>ç¬¬ 39 é€±</span><span>ç¬¬ 52 é€±</span>
    </div>
    <div class="grid" id="grid"></div>
</div>

<div class="overlay" id="overlay" onclick="closeModal()"></div>
<div id="editor-modal">
    <h3>ç·¨è¼¯äººç”Ÿæ ¼é»</h3>
    <input type="text" id="cell-text" placeholder="å­—" maxlength="1" style="width: 50px; text-align: center; font-size: 1.5rem;">
    <div class="color-palette" id="palette"></div>
    <div class="btn-group">
        <button onclick="saveBatch()">å„²å­˜è®Šæ›´</button>
        <button class="clear-btn" onclick="clearBatch()">æ¸…ç©ºé€™äº›æ ¼å­</button>
        <button class="cancel-btn" onclick="closeModal()">å–æ¶ˆ</button>
    </div>
</div>

<script>
    const totalWeeks = 90 * 52;
    let selectedIndices = [];
    let isDragging = false;
    let lifeData = JSON.parse(localStorage.getItem('lifeData')) || {};
    let currentSelectedColor = null;

    const pastelColors = ['#FFB7B2', '#FFDAC1', '#E2F0CB', '#B5EAD7', '#C7CEEA', '#F3FFE3', '#FFCCF9', '#B2E2F2'];

    const palette = document.getElementById('palette');
    pastelColors.forEach(c => {
        const div = document.createElement('div');
        div.className = 'color-opt';
        div.style.backgroundColor = c;
        div.onclick = () => {
            document.querySelectorAll('.color-opt').forEach(el => el.classList.remove('active'));
            div.classList.add('active');
            currentSelectedColor = c;
        };
        palette.appendChild(div);
    });

    function init() {
        const bday = localStorage.getItem('birthday');
        if (bday) {
            document.getElementById('birthday-input').value = bday;
            renderGrid(bday);
        }
    }

    function updateBirthday() {
        const bday = document.getElementById('birthday-input').value;
        if (!bday) return alert("è«‹å…ˆé¸æ“‡å‡ºç”Ÿæ—¥æœŸ");
        localStorage.setItem('birthday', bday);
        renderGrid(bday);
    }

    function renderGrid(bday) {
        const grid = document.getElementById('grid');
        grid.innerHTML = '';
        const birthDate = new Date(bday);
        const today = new Date();
        const passedWeeks = Math.floor((today - birthDate) / (1000 * 60 * 60 * 24 * 7));

        document.getElementById('cur-week').innerText = passedWeeks;
        document.getElementById('rem-week').innerText = Math.max(0, totalWeeks - passedWeeks);

        for (let i = 0; i < totalWeeks; i++) {
            const cell = document.createElement('div');
            cell.className = 'cell';
            cell.id = 'cell-' + i;
            if (i < passedWeeks) cell.classList.add('past');
            else if (i === passedWeeks) cell.classList.add('present');

            if (lifeData[i]) {
                cell.style.backgroundColor = lifeData[i].color || '#ffffffcc';
                cell.innerText = lifeData[i].text || '';
            }

            cell.onmousedown = () => { isDragging = true; selectedIndices = [i]; clearSelectionStyles(); cell.classList.add('selected'); };
            cell.onmouseover = () => { if (isDragging && !selectedIndices.includes(i)) { selectedIndices.push(i); cell.classList.add('selected'); } };
            grid.appendChild(cell);
        }
    }

    // å®šä½è·³è½‰åŠŸèƒ½
    function jumpToDate() {
        const bdayStr = localStorage.getItem('birthday');
        const targetStr = document.getElementById('jump-date-input').value;
        if (!bdayStr) return alert("è«‹å…ˆè¨­å®šå‡ºç”Ÿæ—¥æœŸ");
        if (!targetStr) return alert("è«‹é¸æ“‡è¦è·³è½‰çš„æ—¥æœŸ");

        const birthDate = new Date(bdayStr);
        const targetDate = new Date(targetStr);
        const weekIndex = Math.floor((targetDate - birthDate) / (1000 * 60 * 60 * 24 * 7));

        if (weekIndex < 0 || weekIndex >= totalWeeks) {
            return alert("è©²æ—¥æœŸè¶…å‡ºäº† 90 å¹´çš„äººç”Ÿç¯„åœ");
        }

        const targetCell = document.getElementById('cell-' + weekIndex);
        if (targetCell) {
            // æ¸…é™¤èˆŠçš„é«˜äº®
            document.querySelectorAll('.target-highlight').forEach(el => el.classList.remove('target-highlight'));
            
            // åŠ å…¥æ–°é«˜äº®
            targetCell.classList.add('target-highlight');
            
            // è‡ªå‹•æ²å‹•
            targetCell.scrollIntoView({ behavior: 'smooth', block: 'center', inline: 'center' });
        }
    }

    window.onmouseup = () => { if (isDragging) { isDragging = false; if (selectedIndices.length > 0) openModal(); } };
    function clearSelectionStyles() { document.querySelectorAll('.cell.selected').forEach(c => c.classList.remove('selected')); }
    function openModal() { document.getElementById('overlay').style.display = 'block'; document.getElementById('editor-modal').style.display = 'block'; currentSelectedColor = null; document.getElementById('cell-text').value = ''; }
    function closeModal() { document.getElementById('overlay').style.display = 'none'; document.getElementById('editor-modal').style.display = 'none'; clearSelectionStyles(); }
    
    function saveBatch() {
        const text = document.getElementById('cell-text').value;
        selectedIndices.forEach(idx => {
            if (!lifeData[idx]) lifeData[idx] = {};
            if (currentSelectedColor) lifeData[idx].color = currentSelectedColor;
            if (text !== "") lifeData[idx].text = text;
        });
        finalize();
    }

    function clearBatch() {
        if (confirm("æ¸…ç©ºé¸å–æ ¼ï¼Ÿ")) { selectedIndices.forEach(idx => delete lifeData[idx]); finalize(); }
    }

    function finalize() { localStorage.setItem('lifeData', JSON.stringify(lifeData)); renderGrid(localStorage.getItem('birthday')); closeModal(); }

    init();
</script>
</body>
</html>