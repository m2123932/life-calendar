<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ‚ ä¸€ç”Ÿçš„é€±è¡Œäº‹æ›†</title>
    <style>
        :root {
            --wood-dark: #3e2723; --wood-med: #5d4037; --paper: #fdfaf1;
            --p1: #FFB7B2; --p2: #FFDAC1; --p3: #E2F0CB; --p4: #B5EAD7;
            --p5: #C7CEEA; --p6: #F3FFE3; --p7: #FFCCF9; --p8: #B2E2F2;
        }
        body {
            background-color: var(--wood-dark);
            background-image: url('https://www.transparenttextures.com/patterns/dark-wood.png');
            color: var(--wood-dark); font-family: "PingFang TC", "Microsoft JhengHei", serif;
            margin: 0; padding: 0; display: flex; flex-direction: column; align-items: center;
        }

        /* å›ºå®šä¸Šæ–¹çš„æ§åˆ¶å€ */
        .sticky-header {
            position: sticky; top: 0; z-index: 100;
            width: 100%; display: flex; justify-content: center;
            background: rgba(62, 39, 35, 0.9); padding: 15px 0;
            backdrop-filter: blur(5px);
        }

        .header-card {
            background: var(--paper); padding: 20px; border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5); text-align: center;
            width: 90%; max-width: 850px; border: 3px solid var(--wood-med);
        }

        .user-section { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; background: #efebe9; padding: 8px; border-radius: 8px; }
        .user-pic { width: 30px; height: 30px; border-radius: 50%; border: 2px solid var(--wood-med); }
        .control-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 10px 0; border-top: 1px dashed #ccc; border-bottom: 1px dashed #ccc; padding: 10px 0; }
        
        /* é€±æ›†æœ¬é«” */
        .calendar-outer { background: var(--paper); padding: 20px; border-radius: 8px; overflow-x: auto; max-width: 95vw; box-shadow: inset 0 0 10px rgba(0,0,0,0.2); margin: 20px 0 50px 0; }
        .grid { display: grid; grid-template-columns: repeat(52, 18px); gap: 3px; user-select: none; }
        .cell { width: 18px; height: 18px; border: 1px solid rgba(0,0,0,0.1); font-size: 11px; text-align: center; line-height: 18px; cursor: pointer; background: #ffffffcc; box-sizing: border-box; }
        .cell.past { filter: brightness(0.95); border-style: dotted; }
        .cell.present { border: 2px solid #d32f2f; animation: pulse 2s infinite; }
        .cell.selected { outline: 2px solid #ff5722; z-index: 10; transform: scale(1.1); }
        .cell.target-highlight { outline: 3px solid #000 !important; animation: highlight-blink 0.8s 4; z-index: 50; }

        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        @keyframes highlight-blink { 0%, 100% { transform: scale(1); background: yellow; } 50% { transform: scale(1.5); background: white; } }
        
        /* å½ˆçª— */
        #editor-modal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--paper); padding: 25px; border-radius: 15px; box-shadow: 0 0 50px rgba(0,0,0,0.8); z-index: 200; border: 5px solid var(--wood-med); text-align: center; }
        .color-palette { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin: 15px 0; }
        .color-opt { width: 35px; height: 35px; border-radius: 6px; cursor: pointer; border: 1px solid #ccc; }
        .color-opt.active { border: 3px solid #333; }
        button { background: var(--wood-med); color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .overlay { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.6); z-index: 150; }
    </style>
</head>
<body>

<div class="sticky-header">
    <div class="header-card">
        <div class="user-section">
            <div style="display:flex; align-items:center; gap:10px;">
                <img id="user-img" class="user-pic" style="display:none">
                <span id="user-name">è¨ªå®¢æ¨¡å¼</span>
            </div>
            <button id="auth-btn">Google ç™»å…¥åŒæ­¥</button>
        </div>
        <h2 style="margin:5px 0;">ğŸ‚ ä¸€ç”Ÿçš„é€±è¡Œäº‹æ›†</h2>
        <div id="stats" style="font-size:0.9rem; margin-bottom:10px; font-weight:bold; color:var(--wood-med);">
            ç›®å‰äººç”Ÿç¬¬ <span id="cur-week">-</span> é€± | å‰©é¤˜ <span id="rem-week">-</span> é€±
        </div>
        <div class="control-row">
            <div>ğŸ‘¶ å‡ºç”Ÿï¼š<input type="date" id="birthday-input"></div>
            <div>ğŸ” è·³è½‰ï¼š<input type="date" id="jump-date"></div>
        </div>
    </div>
</div>

<div class="calendar-outer">
    <div class="grid" id="grid"></div>
</div>

<div class="overlay" id="overlay"></div>
<div id="editor-modal">
    <h3>ç·¨è¼¯äººç”Ÿæ ¼é»</h3>
    <input type="text" id="cell-text" placeholder="å­—" maxlength="1" style="width: 50px; text-align: center; font-size: 1.5rem; border:1px solid #ccc;">
    <div class="color-palette" id="palette"></div>
    <div style="display:flex; flex-direction:column; gap:8px;">
        <button id="save-btn">å„²å­˜è®Šæ›´</button>
        <button style="background:#d7ccc8; color:#3e2723;" id="clear-btn">æ¸…ç©ºå…§å®¹</button>
        <button style="background:#999;" id="close-btn">å–æ¶ˆ</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    // Firebase Config
    const firebaseConfig = {
        apiKey: "AIzaSyCyeJQKaGgswiw0W-RjgxeRw2LYM_2Uyas",
        authDomain: "life-calendar-361db.firebaseapp.com",
        projectId: "life-calendar-361db",
        storageBucket: "life-calendar-361db.firebasestorage.app",
        messagingSenderId: "801402347327",
        appId: "1:801402347327:web:a5ff8adfe544eaf1927d8a"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    let currentUser = null;
    let lifeData = {};
    let selectedIndices = [];
    let isDragging = false;
    let currentSelectedColor = null;
    const totalWeeks = 90 * 52;
    const colors = ['#FFB7B2', '#FFDAC1', '#E2F0CB', '#B5EAD7', '#C7CEEA', '#F3FFE3', '#FFCCF9', '#B2E2F2'];

    // åˆå§‹åŒ–
    colors.forEach(c => {
        const div = document.createElement('div');
        div.className = 'color-opt';
        div.style.backgroundColor = c;
        div.onclick = () => {
            document.querySelectorAll('.color-opt').forEach(el => el.classList.remove('active'));
            div.classList.add('active');
            currentSelectedColor = c;
        };
        document.getElementById('palette').appendChild(div);
    });

    onAuthStateChanged(auth, async (user) => {
        currentUser = user;
        if (user) {
            document.getElementById('user-name').innerText = user.displayName;
            document.getElementById('user-img').src = user.photoURL;
            document.getElementById('user-img').style.display = 'block';
            document.getElementById('auth-btn').innerText = 'ç™»å‡º';
            
            const docSnap = await getDoc(doc(db, "users", user.uid));
            if (docSnap.exists()) {
                const data = docSnap.data();
                lifeData = data.lifeData || {};
                if (data.birthday) localStorage.setItem('birthday', data.birthday);
            }
        } else {
            document.getElementById('user-name').innerText = 'è¨ªå®¢æ¨¡å¼';
            document.getElementById('user-img').style.display = 'none';
            document.getElementById('auth-btn').innerText = 'Google ç™»å…¥åŒæ­¥';
        }
        document.getElementById('birthday-input').value = localStorage.getItem('birthday') || '';
        renderGrid();
    });

    document.getElementById('auth-btn').onclick = () => {
        if (currentUser) signOut(auth);
        else signInWithPopup(auth, provider);
    };

    async function sync() {
        localStorage.setItem('lifeData', JSON.stringify(lifeData));
        if (currentUser) {
            await setDoc(doc(db, "users", currentUser.uid), {
                lifeData: lifeData,
                birthday: document.getElementById('birthday-input').value
            });
        }
    }

    function renderGrid() {
        const grid = document.getElementById('grid');
        grid.innerHTML = '';
        const bday = document.getElementById('birthday-input').value;
        if (!bday) return;

        const birthDate = new Date(bday);
        const passedWeeks = Math.floor((new Date() - birthDate) / (1000 * 60 * 60 * 24 * 7));
        document.getElementById('cur-week').innerText = passedWeeks;
        document.getElementById('rem-week').innerText = Math.max(0, totalWeeks - passedWeeks);

        for (let i = 0; i < totalWeeks; i++) {
            const cell = document.createElement('div');
            cell.className = 'cell';
            cell.id = `cell-${i}`;
            if (i < passedWeeks) cell.classList.add('past');
            else if (i === passedWeeks) cell.classList.add('present');
            
            if (lifeData[i]) {
                cell.style.backgroundColor = lifeData[i].color;
                cell.innerText = lifeData[i].text || '';
            }

            cell.onmousedown = () => { isDragging = true; selectedIndices = [i]; clearSelection(); cell.classList.add('selected'); };
            cell.onmouseover = () => { if (isDragging && !selectedIndices.includes(i)) { selectedIndices.push(i); cell.classList.add('selected'); } };
            grid.appendChild(cell);
        }
    }

    document.getElementById('birthday-input').onchange = () => {
        localStorage.setItem('birthday', document.getElementById('birthday-input').value);
        renderGrid();
        sync();
    };

    window.onmouseup = () => { if (isDragging) { isDragging = false; document.getElementById('overlay').style.display = 'block'; document.getElementById('editor-modal').style.display = 'block'; } };
    
    function clearSelection() { document.querySelectorAll('.cell.selected').forEach(c => c.classList.remove('selected')); }
    function closeModal() { document.getElementById('overlay').style.display = 'none'; document.getElementById('editor-modal').style.display = 'none'; clearSelection(); }
    
    document.getElementById('save-btn').onclick = () => {
        const txt = document.getElementById('cell-text').value;
        selectedIndices.forEach(idx => {
            lifeData[idx] = { color: currentSelectedColor || (lifeData[idx]?.color || '#fff'), text: txt || (lifeData[idx]?.text || '') };
        });
        sync().then(() => { renderGrid(); closeModal(); });
    };

    document.getElementById('clear-btn').onclick = () => {
        selectedIndices.forEach(idx => delete lifeData[idx]);
        sync().then(() => { renderGrid(); closeModal(); });
    };

    document.getElementById('close-btn').onclick = closeModal;

    // ä¿®å¾©å¾Œçš„è·³è½‰åŠŸèƒ½
    document.getElementById('jump-date').onchange = () => {
        const bdayVal = document.getElementById('birthday-input').value;
        const jumpVal = document.getElementById('jump-date').value;
        if (!bdayVal) return alert("è«‹å…ˆé¸æ“‡å‡ºç”Ÿæ—¥æœŸ");

        const target = new Date(jumpVal);
        const birth = new Date(bdayVal);
        const timeDiff = target - birth;
        const idx = Math.floor(timeDiff / (1000 * 60 * 60 * 24 * 7));

        if (idx < 0 || idx >= totalWeeks) return alert("è©²æ—¥æœŸè¶…å‡ºäº† 90 å¹´çš„äººç”Ÿç¯„åœ");

        const el = document.getElementById(`cell-${idx}`);
        if (el) {
            document.querySelectorAll('.target-highlight').forEach(c => c.classList.remove('target-highlight'));
            el.classList.add('target-highlight');
            // è¨ˆç®—æ²å‹•ä½ç½®ï¼Œè€ƒæ…®å›ºå®šæ¨™é¡Œçš„é«˜åº¦
            const headerHeight = document.querySelector('.sticky-header').offsetHeight;
            const elementRect = el.getBoundingClientRect();
            const absoluteElementTop = elementRect.top + window.pageYOffset;
            const middleOffset = window.innerHeight / 2;
            
            window.scrollTo({
                top: absoluteElementTop - middleOffset,
                behavior: 'smooth'
            });
        }
    };
</script>
</body>
</html>
